Ω+
M/Users/christophehavard/Sonar/surfrider_fillbidatabase/DictionaryExtension.cs
	namespace 	
	Surfrider
 
. 
Common 
. 

Extensions %
{ 
public 

static 
class  
DictionaryExtensions ,
{ 
internal 
static 
bool 
TryGetValue (
<( )
T) *
>* +
(+ ,
this, 0
IDictionary1 <
<< =
string= C
,C D
objectE K
>K L

dictionaryM W
,W X
stringY _
key` c
,c d
oute h
Ti j
valuek p
)p q
{ 	
object 
valueObj 
; 
if 
( 

dictionary 
. 
TryGetValue &
(& '
key' *
,* +
out, /
valueObj0 8
)8 9
&&: <
valueObj= E
isF H
TI J
)J K
{ 
value 
= 
( 
T 
) 
valueObj #
;# $
return 
true 
; 
} 
value 
= 
default 
( 
T 
) 
; 
return 
false 
; 
} 	
public%% 
static%% 
TValue%% '
GetOrDefaultCaseInsensitive%% 8
<%%8 9
TValue%%9 ?
>%%? @
(%%@ A
this%%A E
IDictionary%%F Q
<%%Q R
string%%R X
,%%X Y
TValue%%Z `
>%%` a

dictionary%%b l
,%%l m
string%%n t
key%%u x
)%%x y
{&& 	
TValue'' 
obj'' 
;'' 
return(( 

dictionary(( 
.(( 
TryGetValue(( )
((() *
key((* -
.((- .
ToUpperInvariant((. >
(((> ?
)((? @
,((@ A
out((B E
obj((F I
)((I J
?((K L
obj((M P
:((Q R
default((S Z
(((Z [
TValue(([ a
)((a b
;((b c
})) 	
public33 
static33 
TValue33 
GetOrDefault33 )
<33) *
TKey33* .
,33. /
TValue330 6
>336 7
(337 8
this338 <
IDictionary33= H
<33H I
TKey33I M
,33M N
TValue33O U
>33U V

dictionary33W a
,33a b
TKey33c g
key33h k
)33k l
{44 	
TValue55 
obj55 
;55 
return66 

dictionary66 
.66 
TryGetValue66 )
(66) *
key66* -
,66- .
out66/ 2
obj663 6
)666 7
?668 9
obj66: =
:66> ?
default66@ G
(66G H
TValue66H N
)66N O
;66O P
}77 	
publicAA 
staticAA 
IListAA 
<AA 
TValueAA "
>AA" #
GetKeysAA$ +
<AA+ ,
TKeyAA, 0
,AA0 1
TValueAA2 8
>AA8 9
(AA9 :
thisAA: >
IDictionaryAA? J
<AAJ K
TKeyAAK O
,AAO P
TValueAAQ W
>AAW X

dictionaryAAY c
,AAc d
IListAAe j
<AAj k
TKeyAAk o
>AAo p
keysAAq u
)AAu v
{BB 	
IListCC 
<CC 
TValueCC 
>CC 
objsCC 
=CC  
newCC! $
ListCC% )
<CC) *
TValueCC* 0
>CC0 1
(CC1 2
)CC2 3
;CC3 4
foreachEE 
(EE 
TKeyEE 
keyEE 
inEE  
keysEE! %
)EE% &
{FF 
ifGG 
(GG 

dictionaryGG 
.GG 
ContainsKeyGG *
(GG* +
keyGG+ .
)GG. /
)GG/ 0
{HH 
objsII 
.II 
AddII 
(II 

dictionaryII '
[II' (
keyII( +
]II+ ,
)II, -
;II- .
}JJ 
}KK 
returnMM 
objsMM 
;MM 
}NN 	
publicYY 
staticYY 
TValueYY 
GetOrAddYY %
<YY% &
TKeyYY& *
,YY* +
TValueYY, 2
>YY2 3
(YY3 4
thisYY4 8
IDictionaryYY9 D
<YYD E
TKeyYYE I
,YYI J
TValueYYK Q
>YYQ R

dictionaryYYS ]
,YY] ^
TKeyYY_ c
keyYYd g
,YYg h
FuncYYi m
<YYm n
TKeyYYn r
,YYr s
TValueYYt z
>YYz {
factory	YY| É
)
YYÉ Ñ
{ZZ 	
TValue[[ 
obj[[ 
;[[ 
if\\ 
(\\ 

dictionary\\ 
.\\ 
TryGetValue\\ &
(\\& '
key\\' *
,\\* +
out\\, /
obj\\0 3
)\\3 4
)\\4 5
{]] 
return^^ 
obj^^ 
;^^ 
}__ 
returnaa 

dictionaryaa 
[aa 
keyaa !
]aa! "
=aa# $
factoryaa% ,
(aa, -
keyaa- 0
)aa0 1
;aa1 2
}bb 	
}cc 
}dd ∑
@/Users/christophehavard/Sonar/surfrider_fillbidatabase/Helper.cs
	namespace 	
	Surfrider
 
{ 
public 
static 
class 
Helper 
{ 
private

 
static

 
string

 '
GetKeyVaultConnectionString

 9
(

9 :
string

: @

secretName

A K
)

K L
{ 	
string 
keyVaultName 
=  !
Environment" -
.- ."
GetEnvironmentVariable. D
(D E
$strE U
)U V
;V W
var 
kvUri 
= 
$str "
+# $
keyVaultName% 1
+2 3
$str4 F
;F G
var 
client 
= 
new 
SecretClient )
() *
new* -
Uri. 1
(1 2
kvUri2 7
)7 8
,8 9
new: ="
DefaultAzureCredential> T
(T U
)U V
)V W
;W X
KeyVaultSecret 
secret !
=" #
client$ *
.* +
	GetSecret+ 4
(4 5

secretName5 ?
)? @
;@ A
return 
secret 
. 
Value 
;  
} 	
public 
static 
string 
GetConnectionString 0
(0 1
)1 2
{ 	
return 
Environment "
." #"
GetEnvironmentVariable# 9
(9 :
$str: N
)N O
;O P
} 	
} 
} ∑
C/Users/christophehavard/Sonar/surfrider_fillbidatabase/IDatabase.cs
	namespace 	
	Surfrider
 
{ 
public 

	interface 
	IDatabase 
{		 
Task

 
<

 
int

 
>

 
ExecuteNonQuery

 !
(

! "
string

" (
query

) .
,

. /
IDictionary

0 ;
<

; <
string

< B
,

B C
object

D J
>

J K
args

L P
=

Q R
null

S W
)

W X
;

X Y
Task 
< 
string 
> 
ExecuteStringQuery '
(' (
string( .
query/ 4
,4 5
IDictionary6 A
<A B
stringB H
,H I
objectJ P
>P Q
argsR V
=W X
nullY ]
)] ^
;^ _
} 
} Ú
I/Users/christophehavard/Sonar/surfrider_fillbidatabase/OperationStatus.cs
	namespace 	
	Surfrider
 
. 
Jobs 
. 
	Recurring "
{ 
public 

enum 
OperationStatus 
{  !
OK 

= 
$num 
, 
WARNING 
= 
$num 
, 
ERROR 
= 
$num 
} 
} É!
I/Users/christophehavard/Sonar/surfrider_fillbidatabase/PostgreDatabase.cs
	namespace 	
	Surfrider
 
{ 
public		 

class		 
PostgreDatabase		  
:		! "
	IDatabase		# ,
{

 
string 
ConnectionString 
;  
public 
PostgreDatabase 
( 
string %
connectionString& 6
)6 7
{ 	
this 
. 
ConnectionString !
=" #
connectionString$ 4
;4 5
} 	
public 
async 
Task 
< 
int 
> 
ExecuteNonQuery .
(. /
string/ 5
query6 ;
,; <
IDictionary= H
<H I
stringI O
,O P
objectQ W
>W X
argsY ]
=^ _
null` d
)d e
{ 	
using 
( 
var 
conn 
= 
new !
NpgsqlConnection" 2
(2 3
ConnectionString3 C
)C D
)D E
{ 
conn 
. 
Open 
( 
) 
; 
using 
( 
var 
cmd 
=  
new! $
NpgsqlCommand% 2
(2 3
)3 4
)4 5
{ 
cmd 
. 

Connection "
=# $
conn% )
;) *
cmd 
. 
CommandText #
=$ %
query& +
;+ ,
foreach 
( 
var 
arg  #
in$ &
args' +
)+ ,
{, -
cmd 
. 

Parameters &
.& '
AddWithValue' 3
(3 4
arg4 7
.7 8
Key8 ;
,; <
arg= @
.@ A
ValueA F
)F G
;G H
} 
return 
await  
cmd! $
.$ % 
ExecuteNonQueryAsync% 9
(9 :
): ;
;; <
} 
} 
}   	
public"" 
async"" 
Task"" 
<"" 
string""  
>""  !
ExecuteStringQuery""" 4
(""4 5
string""5 ;
query""< A
,""A B
IDictionary""C N
<""N O
string""O U
,""U V
object""W ]
>""] ^
args""_ c
=""d e
null""f j
)""j k
{## 	
string$$ 
res$$ 
=$$ 
string$$ 
.$$  
Empty$$  %
;$$% &
using%% 
(%% 
var%% 
conn%% 
=%% 
new%% !
NpgsqlConnection%%" 2
(%%2 3
ConnectionString%%3 C
)%%C D
)%%D E
{&& 
conn'' 
.'' 
Open'' 
('' 
)'' 
;'' 
using(( 
((( 
var(( 
cmd(( 
=((  
new((! $
NpgsqlCommand((% 2
(((2 3
)((3 4
)((4 5
{)) 
cmd** 
.** 

Connection** "
=**# $
conn**% )
;**) *
cmd++ 
.++ 
CommandText++ #
=++$ %
query++& +
;+++ ,
using,, 
(,, 
var,, 
reader,, %
=,,& '
await,,( -
cmd,,. 1
.,,1 2
ExecuteReaderAsync,,2 D
(,,D E
),,E F
),,F G
{-- 
while.. 
(.. 
reader.. %
...% &
Read..& *
(..* +
)..+ ,
).., -
{// 
res00 
+=00  "
reader00# )
.00) *
	GetString00* 3
(003 4
$num004 5
)005 6
;006 7
}11 
}22 
}33 
}44 
return55 
res55 
;55 
}66 	
}77 
}88 …ä
M/Users/christophehavard/Sonar/surfrider_fillbidatabase/PowerBIFillDatabase.cs
	namespace 	
	Surfrider
 
. 
Jobs 
. 
	Recurring "
{		 
public

 

static

 
class

 
PowerBIFillDatabase

 +
{ 
public 
static 
	IDatabase 
Database  (
;( )
[ 	
FunctionName	 
( 
$str +
)+ ,
], -
public 
static 
async 
Task  
Run! $
($ %
[% &
TimerTrigger& 2
(2 3
$str3 @
)@ A
]A B
	TimerInfoB K
myTimerL S
,S T
ILoggerU \
logger] c
)c d
{ 	
Console 
. 
	WriteLine 
( 
$str &
+' (
Helper) /
./ 0
GetConnectionString0 C
(C D
)D E
)E F
;F G
Database 
= 
new 
PostgreDatabase *
(* +
Helper+ 1
.1 2
GetConnectionString2 E
(E F
)F G
)G H
;H I
var 
	startedOn 
= 
DateTime $
.$ %
Now% (
;( )
IList 
< 
Guid 

>
 
newCampaignsIds 
= 
new !
List" &
<& '
Guid' +
>+ ,
(, -
)- .
;. /
newCampaignsIds 
. 
Add 
( 
new 
Guid 
( 
$str C
)C D
)D E
;E F
newCampaignsIds   
.   
Add   
(   
new   
Guid   
(   
$str   C
)  C D
)  D E
;  E F
await"" (
InsertNewCampaignsInBiSchema"" .
("". /
newCampaignsIds""/ >
)""> ?
;""? @
Console// 
.// 
	WriteLine// 
(// 
$str// S
)//S T
;//T U
}11 	
private33 
static33 
string33 
FormatGuidsForSQL33 /
(33/ 0
IList330 5
<335 6
Guid336 :
>33: ;
newCampaignsIds33< K
)33K L
{44 	
var55 
res55 
=55 
$str55 
;55 
for66 
(66 
int66 
i66 
=66 
$num66 
;66 
i66 
<66 
newCampaignsIds66 .
.66. /
Count66/ 4
;664 5
i666 7
++667 9
)669 :
{66: ;
res88 
+=88 
$str88 
+88 
newCampaignsIds88 ,
[88, -
i88- .
]88. /
+880 1
$str882 5
;885 6
if99 
(99 
i99 
<99 
newCampaignsIds99 &
.99& '
Count99' ,
-99- .
$num99/ 0
)990 1
res:: 
+=:: 
$str:: 
;:: 
};; 
return<< 
res<< 
;<< 
}== 	
private?? 
static?? 
async?? 
Task?? !
CleanErrors??" -
(??- .
)??. /
{@@ 	
}BB 	
privateOO 
staticOO 
asyncOO 
TaskOO !)
UpdateCampaignTrajectoryPointOO" ?
(OO? @
ILoggerOO@ G
loggerOOH N
,OON O
stringOOP V
newCampaignsIdsOOW f
)OOf g
{PP 	
varRR 
commandRR 
=RR 
$"RR 7
+DO $$ DECLARE campaign_ids uuid[] := ARRAY[RR G
{RRG H
newCampaignsIdsRRH W
}RRW X
];RRX Z
"RRZ [
;RR[ \
commandSS 
+=SS 
$strSS :
;SS: ;
commandTT 
+=TT 
$strTT R
;TTR S
commandUU 
+=UU 
$strUU -
;UU- .
commandVV 
+=VV 
$strVV ?
;VV? @
commandWW 
+=WW 
$strWW *
;WW* +
commandXX 
+=XX 
$strXX Y
;XXY Z
IDictionary[[ 
<[[ 
string[[ 
,[[ 
object[[  &
>[[& '
args[[( ,
=[[- .
new[[/ 2

Dictionary[[3 =
<[[= >
string[[> D
,[[D E
object[[F L
>[[L M
([[M N
)[[N O
;[[O P
await\\ 
Database\\ 
.\\ 
ExecuteNonQuery\\ *
(\\* +
command\\+ 2
,\\2 3
args\\4 8
)\\8 9
;\\9 :
}]] 	
privatedd 
staticdd 
asyncdd 
Taskdd !)
ComputeMetricsOnCampaignRiverdd" ?
(dd? @
IListdd@ E
<ddE F
GuidddF J
>ddJ K
newCampaignsIdsddL [
)dd[ \
{ee 	
vargg 
commandgg 
=gg 
$strgg <
;gg< =
IDictionaryii 
<ii 
stringii 
,ii 
objectii  &
>ii& '
argsii( ,
=ii- .
newii/ 2

Dictionaryii3 =
<ii= >
stringii> D
,iiD E
objectiiF L
>iiL M
(iiM N
)iiN O
;iiO P
argsjj 
.jj 
Addjj 
(jj 
$strjj #
,jj# $
$strjj% +
)jj+ ,
;jj, -
awaitkk 
Databasekk 
.kk 
ExecuteNonQuerykk *
(kk* +
commandkk+ 2
,kk2 3
argskk4 8
)kk8 9
;kk9 :
}ll 	
privatenn 
staticnn 
asyncnn 
Tasknn !'
ComputeTrajectoryPointRivernn" =
(nn= >
IListnn> C
<nnC D
GuidnnD H
>nnH I
newCampaignsIdsnnJ Y
)nnY Z
{oo 	
varqq 
commandqq 
=qq 
$strqq <
;qq< =
IDictionaryss 
<ss 
stringss 
,ss 
objectss  &
>ss& '
argsss( ,
=ss- .
newss/ 2

Dictionaryss3 =
<ss= >
stringss> D
,ssD E
objectssF L
>ssL M
(ssM N
)ssN O
;ssO P
argstt 
.tt 
Addtt 
(tt 
$strtt #
,tt# $
$strtt% +
)tt+ ,
;tt, -
awaituu 
Databaseuu 
.uu 
ExecuteNonQueryuu *
(uu* +
commanduu+ 2
,uu2 3
argsuu4 8
)uu8 9
;uu9 :
}vv 	
private}} 
static}} 
async}} 
Task}} !&
ProjectTrashOnClosestRiver}}" <
(}}< =
IList}}= B
<}}B C
Guid}}C G
>}}G H
newCampaignsIds}}I X
)}}X Y
{~~ 	
var
ÄÄ 
command
ÄÄ 
=
ÄÄ 
$str
ÄÄ <
;
ÄÄ< =
IDictionary
ÇÇ 
<
ÇÇ 
string
ÇÇ 
,
ÇÇ 
object
ÇÇ  &
>
ÇÇ& '
args
ÇÇ( ,
=
ÇÇ- .
new
ÇÇ/ 2

Dictionary
ÇÇ3 =
<
ÇÇ= >
string
ÇÇ> D
,
ÇÇD E
object
ÇÇF L
>
ÇÇL M
(
ÇÇM N
)
ÇÇN O
;
ÇÇO P
args
ÉÉ 
.
ÉÉ 
Add
ÉÉ 
(
ÉÉ 
$str
ÉÉ #
,
ÉÉ# $
$str
ÉÉ% +
)
ÉÉ+ ,
;
ÉÉ, -
await
ÑÑ 
Database
ÑÑ 
.
ÑÑ 
ExecuteNonQuery
ÑÑ *
(
ÑÑ* +
command
ÑÑ+ 2
,
ÑÑ2 3
args
ÑÑ4 8
)
ÑÑ8 9
;
ÑÑ9 :
}
ÖÖ 	
private
íí 
static
íí 
async
íí 
Task
íí !*
InsertNewCampaignsInBiSchema
íí" >
(
íí> ?
IList
íí? D
<
ííD E
Guid
ííE I
>
ííI J
newCampaignsIds
ííK Z
)
ííZ [
{
ìì 	
IDictionary
îî 
<
îî 
string
îî 
,
îî 
object
îî  &
>
îî& '
args
îî( ,
=
îî- .
new
îî/ 2

Dictionary
îî3 =
<
îî= >
string
îî> D
,
îîD E
object
îîF L
>
îîL M
(
îîM N
)
îîN O
;
îîO P
args
ïï 
.
ïï 
Add
ïï 
(
ïï 
$str
ïï #
,
ïï# $
$str
ïï% +
)
ïï+ ,
;
ïï, -
var
ññ 
command
ññ 
=
ññ 
System
ññ  
.
ññ  !
IO
ññ! #
.
ññ# $
File
ññ$ (
.
ññ( )
ReadAllText
ññ) 4
(
ññ4 5
$str
ññ5 ]
)
ññ] ^
;
ññ^ _
command
óó 
=
óó 
command
óó 
.
óó 
Replace
óó %
(
óó% &
$str
óó& 5
,
óó5 6
newCampaignsIds
óó6 E
.
óóE F
ToString
óóF N
(
óóN O
)
óóO P
)
óóP Q
;
óóQ R
await
òò 
Database
òò 
.
òò 
ExecuteNonQuery
òò *
(
òò* +
command
òò+ 2
,
òò2 3
args
òò4 8
)
òò8 9
;
òò9 :
await
öö "
ComputeDistanceToSea
öö &
(
öö& '
newCampaignsIds
öö' 6
)
öö6 7
;
öö7 8
}
õõ 	
private
ùù 
static
ùù 
async
ùù 
Task
ùù !"
ComputeDistanceToSea
ùù" 6
(
ùù6 7
IList
ùù7 <
<
ùù< =
Guid
ùù= A
>
ùùA B
newCampaignsIds
ùùC R
)
ùùR S
{
ûû 	
var
†† 
command
†† 
=
†† 
$str
†† <
;
††< =
IDictionary
¢¢ 
<
¢¢ 
string
¢¢ 
,
¢¢ 
object
¢¢  &
>
¢¢& '
args
¢¢( ,
=
¢¢- .
new
¢¢/ 2

Dictionary
¢¢3 =
<
¢¢= >
string
¢¢> D
,
¢¢D E
object
¢¢F L
>
¢¢L M
(
¢¢M N
)
¢¢N O
;
¢¢O P
args
££ 
.
££ 
Add
££ 
(
££ 
$str
££ #
,
££# $
$str
££% +
)
££+ ,
;
££, -
await
§§ 
Database
§§ 
.
§§ 
ExecuteNonQuery
§§ *
(
§§* +
command
§§+ 2
,
§§2 3
args
§§4 8
)
§§8 9
;
§§9 :
}
•• 	
private
ßß 
static
ßß 
async
ßß 
Task
ßß !
<
ßß! "
OperationStatus
ßß" 1
>
ßß1 2$
InsertNewCampaignsInBI
ßß3 I
(
ßßI J
IList
ßßJ O
<
ßßO P
Guid
ßßP T
>
ßßT U
newCampaigns
ßßV b
,
ßßb c
ILogger
ßßd k
log
ßßl o
)
ßßo p
{
®® 	
var
™™ 
command
™™ 
=
™™ 
$str
™™ <
;
™™< =
IDictionary
¨¨ 
<
¨¨ 
string
¨¨ 
,
¨¨ 
object
¨¨  &
>
¨¨& '
args
¨¨( ,
=
¨¨- .
new
¨¨/ 2

Dictionary
¨¨3 =
<
¨¨= >
string
¨¨> D
,
¨¨D E
object
¨¨F L
>
¨¨L M
(
¨¨M N
)
¨¨N O
;
¨¨O P
args
≠≠ 
.
≠≠ 
Add
≠≠ 
(
≠≠ 
$str
≠≠ #
,
≠≠# $
$str
≠≠% +
)
≠≠+ ,
;
≠≠, -
await
ÆÆ 
Database
ÆÆ 
.
ÆÆ 
ExecuteNonQuery
ÆÆ *
(
ÆÆ* +
command
ÆÆ+ 2
,
ÆÆ2 3
args
ÆÆ4 8
)
ÆÆ8 9
;
ÆÆ9 :
return
ØØ 
OperationStatus
ØØ "
.
ØØ" #
OK
ØØ# %
;
ØØ% &
}
∞∞ 	
private
≤≤ 
static
≤≤ 
async
≤≤ 
Task
≤≤ !
	InsertLog
≤≤" +
(
≤≤+ ,
DateTime
≤≤, 4
	startedOn
≤≤5 >
,
≤≤> ?
OperationStatus
≤≤@ O
status
≤≤P V
,
≤≤V W
ILogger
≤≤X _
log
≤≤` c
)
≤≤c d
{
≥≥ 	
var
¥¥ 

finishedOn
¥¥ 
=
¥¥ 
DateTime
¥¥ %
.
¥¥% &
Now
¥¥& )
;
¥¥) *
var
µµ 
elapsedTime
µµ 
=
µµ 

finishedOn
µµ (
-
µµ) *
	startedOn
µµ+ 4
;
µµ4 5
var
∑∑ 
command
∑∑ 
=
∑∑ 
$"
∑∑ ^
PINSERT INTO bi.Logs VALUES (@id, @startedOn, @finishedOn, @elapsedTime, @status)
∑∑ l
"
∑∑l m
;
∑∑m n
IDictionary
∏∏ 
<
∏∏ 
string
∏∏ 
,
∏∏ 
object
∏∏  &
>
∏∏& '
args
∏∏( ,
=
∏∏- .
new
∏∏/ 2

Dictionary
∏∏3 =
<
∏∏= >
string
∏∏> D
,
∏∏D E
object
∏∏F L
>
∏∏L M
(
∏∏M N
)
∏∏N O
;
∏∏O P
args
ππ 
.
ππ 
Add
ππ 
(
ππ 
$str
ππ 
,
ππ 
Guid
ππ  
.
ππ  !
NewGuid
ππ! (
(
ππ( )
)
ππ) *
)
ππ* +
;
ππ+ ,
args
∫∫ 
.
∫∫ 
Add
∫∫ 
(
∫∫ 
$str
∫∫ !
,
∫∫! "
	startedOn
∫∫# ,
)
∫∫, -
;
∫∫- .
args
ªª 
.
ªª 
Add
ªª 
(
ªª 
$str
ªª "
,
ªª" #

finishedOn
ªª$ .
)
ªª. /
;
ªª/ 0
args
ºº 
.
ºº 
Add
ºº 
(
ºº 
$str
ºº #
,
ºº# $
elapsedTime
ºº% 0
.
ºº0 1
TotalSeconds
ºº1 =
)
ºº= >
;
ºº> ?
args
ΩΩ 
.
ΩΩ 
Add
ΩΩ 
(
ΩΩ 
$str
ΩΩ 
,
ΩΩ 
status
ΩΩ  &
.
ΩΩ& '
ToString
ΩΩ' /
(
ΩΩ/ 0
)
ΩΩ0 1
)
ΩΩ1 2
;
ΩΩ2 3
await
ææ 
Database
ææ 
.
ææ 
ExecuteNonQuery
ææ *
(
ææ* +
command
ææ+ 2
,
ææ2 3
args
ææ4 8
)
ææ8 9
;
ææ9 :
}
øø 	
private
¡¡ 
static
¡¡ 
async
¡¡ 
Task
¡¡ !
<
¡¡! "
IList
¡¡" '
<
¡¡' (
Guid
¡¡( ,
>
¡¡, -
>
¡¡- ."
RetrieveNewCampaigns
¡¡/ C
(
¡¡C D
ILogger
¡¡D K
log
¡¡L O
)
¡¡O P
{
¬¬ 	
IList
ƒƒ 
<
ƒƒ 
Guid
ƒƒ 
>
ƒƒ 
	campaigns
ƒƒ !
=
ƒƒ" #
new
ƒƒ$ '
List
ƒƒ( ,
<
ƒƒ, -
Guid
ƒƒ- 1
>
ƒƒ1 2
(
ƒƒ2 3
)
ƒƒ3 4
;
ƒƒ4 5
var
≈≈ 

current_ts
≈≈ 
=
≈≈ 
new
≈≈  
DateTime
≈≈! )
(
≈≈) *
$num
≈≈* .
,
≈≈. /
$num
≈≈0 2
,
≈≈2 3
$num
≈≈4 6
)
≈≈6 7
;
≈≈7 8
var
∆∆ 
command
∆∆ 
=
∆∆ 
$"
∆∆ D
6SELECT id FROM campaign.campaign WHERE createdon >=  '
∆∆ R
{
∆∆R S

current_ts
∆∆S ]
}
∆∆] ^
'
∆∆^ _
"
∆∆_ `
;
∆∆` a
string
ÀÀ 
res
ÀÀ 
=
ÀÀ 
string
ÀÀ 
.
ÀÀ  
Empty
ÀÀ  %
;
ÀÀ% &
using
ÃÃ 
(
ÃÃ 
var
ÃÃ 
conn
ÃÃ 
=
ÃÃ 
new
ÃÃ !
NpgsqlConnection
ÃÃ" 2
(
ÃÃ2 3
Helper
ÃÃ3 9
.
ÃÃ9 :!
GetConnectionString
ÃÃ: M
(
ÃÃM N
)
ÃÃN O
)
ÃÃO P
)
ÃÃP Q
{
ÕÕ 
conn
ŒŒ 
.
ŒŒ 
Open
ŒŒ 
(
ŒŒ 
)
ŒŒ 
;
ŒŒ  
using
œœ 
(
œœ 
var
œœ 
cmd
œœ "
=
œœ# $
new
œœ% (
NpgsqlCommand
œœ) 6
(
œœ6 7
)
œœ7 8
)
œœ8 9
{
–– 
cmd
—— 
.
—— 

Connection
—— &
=
——' (
conn
——) -
;
——- .
cmd
““ 
.
““ 
CommandText
““ '
=
““( )
command
““* 1
;
““1 2
using
”” 
(
”” 
var
”” "
reader
””# )
=
””* +
await
””, 1
cmd
””2 5
.
””5 6 
ExecuteReaderAsync
””6 H
(
””H I
)
””I J
)
””J K
{
‘‘ 
while
÷÷ !
(
÷÷" #
reader
÷÷# )
.
÷÷) *
Read
÷÷* .
(
÷÷. /
)
÷÷/ 0
)
÷÷0 1
{
◊◊ 
	campaigns
ÿÿ  )
.
ÿÿ) *
Add
ÿÿ* -
(
ÿÿ- .
reader
ÿÿ. 4
.
ÿÿ4 5
GetFieldValue
ÿÿ5 B
<
ÿÿB C
Guid
ÿÿC G
>
ÿÿG H
(
ÿÿH I
$num
ÿÿI J
)
ÿÿJ K
)
ÿÿK L
;
ÿÿL M
}
ŸŸ 
}
€€ 
}
‹‹ 
}
›› 
return
ﬂﬂ 
	campaigns
ﬂﬂ 
;
ﬂﬂ 
}
‡‡ 	
}
„„ 
}ÂÂ 